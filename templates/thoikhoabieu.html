<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thời khóa biểu</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap');

        :root {
            --bg-color: #f4f7f9;
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --text-color: #555;
            --card-bg: #ffffff;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
            --border-radius: 16px;
        }

        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .page-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 0;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-action {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-action.info {
            background-color: #17a2b8;
        }

        .btn-action.secondary {
            background-color: #6c757d;
        }

        .btn-action:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .btn-action.info:hover {
            background-color: #138496;
        }

        .btn-action.secondary:hover {
            background-color: #5a6268;
        }

        .filter-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .filter-controls select {
            flex: 1;
            min-width: 150px;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            color: var(--text-color);
            background-color: var(--card-bg);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .filter-controls select:focus {
            border-color: var(--secondary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .tkb-card-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .tkb-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            position: relative;
            border: 1px solid #eee;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .tkb-card.today {
            border: 2px solid var(--secondary-color);
            box-shadow: 0 12px 30px rgba(52, 152, 219, 0.2);
            transform: translateY(-5px);
        }

        .tkb-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .tkb-card .icon {
            position: absolute;
            top: 20px;
            right: 20px;
            opacity: 0.1;
            color: var(--secondary-color);
            font-size: 4rem;
        }

        .tkb-card .tkb-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .tkb-card .tkb-meta {
            font-size: 0.95rem;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tkb-card .tkb-meta strong {
            color: var(--primary-color);
        }

        .tkb-card .tkb-room {
            font-size: 0.9rem;
            color: white;
            background-color: var(--secondary-color);
            border-radius: 6px;
            padding: 4px 10px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
        }

        .tkb-card .tkb-link {
            font-size: 0.95rem;
            color: var(--secondary-color);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .tkb-card .tkb-link:hover {
            color: var(--primary-color);
        }

        .tkb-card .tkb-date {
            font-size: 0.95rem;
            color: var(--text-color);
            font-weight: 600;
            margin-top: 10px;
            text-align: right;
        }

        .loading-text,
        .empty-data-message {
            text-align: center;
            padding: 30px;
            font-size: 1.1rem;
            color: var(--text-color);
        }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: auto;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 90%;
            max-width: 700px;
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .close-button {
            color: var(--text-color);
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--secondary-color);
            text-decoration: none;
        }

        .modal-body table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .modal-body table th,
        .modal-body table td {
            border: 1px solid #eee;
            padding: 10px 15px;
            text-align: center;
            font-size: 0.95rem;
        }

        .modal-body table th {
            background-color: #f0f0f0;
            color: var(--primary-color);
            font-weight: 600;
        }

        .modal-body table tbody tr:nth-child(even) {
            background-color: #fcfcfc;
        }

        @media (max-width: 768px) {
            body { padding: 0; }
            .container {
                padding: 0 2px;
                max-width: 100vw;
                width: 100vw;
                box-sizing: border-box;
            }
            .page-title {
                font-size: 1.3rem;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            .button-group {
                width: 100%;
                justify-content: center;
            }
            .btn-action {
                flex-grow: 1;
                font-size: 0.98rem;
                padding: 10px 8px;
            }
            .filter-controls {
                flex-direction: column;
                gap: 8px;
            }
            .tkb-card-list {
                grid-template-columns: 1fr;
                width: 100vw;
                box-sizing: border-box;
            }
            #calendarYearContainer {
                width: 100vw;
                overflow-x: auto;
                box-sizing: border-box;
            }
            .modal-content {
                padding: 10px 4px 16px 4px;
                max-width: 98vw;
                border-radius: 10px;
            }
            .modal-header {
                padding-bottom: 8px;
                margin-bottom: 10px;
            }
            .modal-title {
                font-size: 1.1rem;
            }
            .modal-body {
                padding: 0;
            }
            #calendarDayModalBody > div {
                padding: 10px 6px !important;
                border-radius: 7px !important;
                font-size: 0.97rem !important;
            }
            #calendarDayModalBody .bi-journal-bookmark-fill {
                font-size: 1.3rem !important;
            }
            #calendarDayModalBody .bi-person-fill,
            #calendarDayModalBody .bi-clock,
            #calendarDayModalBody .bi-sun,
            #calendarDayModalBody .bi-geo-alt-fill {
                font-size: 1rem !important;
            }
            #calendarDayModalDate {
                font-size: 1rem;
            }
            #calendarDayModalBody {
                gap: 8px !important;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Popup hiển thị môn học theo ngày -->
        <div id="calendarDayModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Môn học trong ngày <span id="calendarDayModalDate"></span></h5>
                    <span class="close-button" id="closeCalendarDayModal">&times;</span>
                </div>
                <div class="modal-body" id="calendarDayModalBody">
                </div>
            </div>
        </div>
    <div class="header">
        <h2 class="page-title">Thời khóa biểu</h2>
        <div class="button-group">
            <button type="button" class="btn-action info" id="openTietModal"><i class="bi bi-clock-fill"></i> Thời gian biểu</button>
            <button id="refreshTKB" class="btn-action" type="button"><i class="bi bi-arrow-clockwise"></i> Làm mới TKB</button>
            <a href="/" class="btn-action secondary"><i class="bi bi-house-door-fill"></i> Trang chủ</a>
        </div>
    </div>
    <div id="todaySubjectsBox" style="margin-bottom: 25px; display: none;">
    <!-- Nút chuyển đổi chế độ hiển thị -->
    <div style="margin-bottom: 16px; text-align: right;">
        <button id="toggleViewBtn" class="btn-action secondary" type="button" style="min-width:120px;">Xem TKB đầy đủ</button>
    </div>
    <!-- Box hôm nay học gì -->
    <div style="background: #eaf6fb; border-left: 6px solid #3498db; border-radius: 10px; padding: 18px 22px; margin-bottom: 10px;">
        <strong style="font-size: 1.15rem; color: #2c3e50; display: block; margin-bottom: 6px;">
            <i class="bi bi-calendar-event"></i> Hôm nay bạn sẽ học môn gì?
        </strong>
        <ul id="todaySubjectsList" style="margin: 0; padding-left: 20px; color: #2980b9; font-size: 1.05rem;"></ul>
        <div id="todaySubjectsEmpty" style="color: #27ae60; font-size: 1.08rem; display: none; font-weight: 500;">
            <i class="bi bi-emoji-smile"></i> Hôm nay bạn rảnh!
        </div>
    </div>
    <!-- Calendar Year View -->
    <div id="calendarYearContainer" style="margin-bottom: 30px;"></div>
    </div>
    
    <div class="tkb-card-list" id="tkbCardList"><div class="loading-text">Đang tải...</div></div>
</div>

<!-- Modal Tiết học -->
<div id="tietModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title">Thời gian biểu các tiết học</h5>
      <span class="close-button" id="closeTietModal">&times;</span>
    </div>
    <div class="modal-body">
      <table>
          <thead>
              <tr>
                  <th>Tiết</th>
                  <th>Bắt đầu</th>
                  <th>Kết thúc</th>
              </tr>
          </thead>
          <tbody>
              <tr><td>1</td><td>6:45</td><td>7:35</td></tr>
              <tr><td>2</td><td>7:40</td><td>8:30</td></tr>
              <tr><td>3</td><td>8:40</td><td>9:30</td></tr>
              <tr><td>4</td><td>9:40</td><td>10:30</td></tr>
              <tr><td>5</td><td>10:35</td><td>11:25</td></tr>
              <tr><td>6</td><td>13:00</td><td>13:50</td></tr>
              <tr><td>7</td><td>13:55</td><td>14:45</td></tr>
              <tr><td>8</td><td>14:55</td><td>15:45</td></tr>
              <tr><td>9</td><td>15:55</td><td>16:45</td></tr>
              <tr><td>10</td><td>16:50</td><td>17:40</td></tr>
              <tr><td>11</td><td>18:15</td><td>19:05</td></tr>
              <tr><td>12</td><td>19:10</td><td>20:00</td></tr>
              <tr><td>13</td><td>20:05</td><td>20:55</td></tr>
              <tr><td>14</td><td>20:20</td><td>21:10</td></tr>
              <tr><td>15</td><td>21:20</td><td>22:10</td></tr>
          </tbody>
      </table>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Toggle View ---
    const calendarDiv = document.getElementById('calendarYearContainer');
    const cardListDiv = document.getElementById('tkbCardList');
    const toggleViewBtn = document.getElementById('toggleViewBtn');
    const refreshBtn = document.getElementById('refreshTKB');
    let isCalendarView = false;
    function updateViewToggle() {
        if (isCalendarView) {
            calendarDiv.style.display = '';
            cardListDiv.style.display = 'none';
            toggleViewBtn.innerHTML = '<i class="bi bi-list-task"></i> Xem TKB';
            if (refreshBtn) refreshBtn.style.display = 'none';
        } else {
            calendarDiv.style.display = 'none';
            cardListDiv.style.display = '';
            toggleViewBtn.innerHTML = '<i class="bi bi-calendar-week"></i> Xem lịch';
            if (refreshBtn) refreshBtn.style.display = '';
        }
    }
    if (toggleViewBtn) {
        toggleViewBtn.onclick = function() {
            isCalendarView = !isCalendarView;
            updateViewToggle();
        };
        // Mặc định hiển thị lịch, ẩn card
        updateViewToggle();
    }
    // (Đã bỏ chức năng chuyển đổi giữa lịch và TKB đầy đủ)
    // --- Calendar Year ---
    function renderCalendarYear(year) {
        const container = document.getElementById('calendarYearContainer');
        if (!container) return;
        if (!year) year = new Date().getFullYear();
        // Lấy danh sách ngày có lịch học từ window._calendarHasScheduleDates
        let hasSchedule = (window._calendarHasScheduleDates || []);
        // Tạo set để tra cứu nhanh
        let hasScheduleSet = new Set(hasSchedule);
        let months = ["Tháng 1","Tháng 2","Tháng 3","Tháng 4","Tháng 5","Tháng 6","Tháng 7","Tháng 8","Tháng 9","Tháng 10","Tháng 11","Tháng 12"];
        let html = `<div class="calendar-year-grid">`;
        for(let m=0;m<12;m++){
            html += `<div class="calendar-month-box">
                <div class="calendar-month-title">${months[m]}</div>`;
            html += `<table class="calendar-month-table">
                <thead><tr><th>T2</th><th>T3</th><th>T4</th><th>T5</th><th>T6</th><th>T7</th><th>CN</th></tr></thead><tbody>`;
            let firstDay = new Date(year, m, 1).getDay();
            firstDay = firstDay === 0 ? 6 : firstDay-1; // 0=CN->6
            let daysInMonth = new Date(year, m+1, 0).getDate();
            let d=1;
            for(let row=0;d<=daysInMonth;row++){
                html += '<tr>';
                for(let col=0;col<7;col++){
                    if(row===0 && col<firstDay){ html+='<td></td>'; continue; }
                    if(d>daysInMonth){ html+='<td></td>'; continue; }
                    let today = new Date();
                    let isToday = (d===today.getDate() && m===today.getMonth() && year===today.getFullYear());
                    let dateStr = `${year}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    let isHasSchedule = hasScheduleSet.has(dateStr);
                    let style = '';
                    let clickable = '';
                    if(isToday) style += 'background:#3498db;color:#fff;font-weight:700;box-shadow:0 0 0 2px #3498db33;';
                    else if(isHasSchedule) { style += 'background:#ffe066;color:#2c3e50;font-weight:700;border:1.5px solid #f9c846;cursor:pointer;'; clickable = `data-date='${dateStr}'`; }
                    html += `<td style=\"padding:2px;\"><div style=\"width:28px;height:28px;line-height:28px;border-radius:50%;margin:auto;${style}\" ${clickable}>${d}</div></td>`;
                    d++;
                }
                html += '</tr>';
            }
            html += '</tbody></table></div>';
        }
        html += '</div>';
        container.innerHTML = html;
        // Inject responsive CSS for calendar grid if not already present
        if (!document.getElementById('calendar-year-grid-style')) {
            const style = document.createElement('style');
            style.id = 'calendar-year-grid-style';
            style.innerHTML = `
                .calendar-year-grid {
                    display: grid;
                    grid-template-columns: repeat(4, 1fr);
                    gap: 18px;
                }
                .calendar-month-box {
                    background: #f8fafc;
                    border-radius: 12px;
                    box-shadow: 0 2px 8px #0001;
                    padding: 12px 8px 8px 8px;
                }
                .calendar-month-title {
                    font-weight: 600;
                    color: #3498db;
                    text-align: center;
                    margin-bottom: 6px;
                }
                .calendar-month-table {
                    width: 100%;
                    font-size: 0.98em;
                    text-align: center;
                }
                @media (max-width: 768px) {
                    .calendar-year-grid {
                        grid-template-columns: 1fr;
                        gap: 12px;
                    }
                }
            `;
            document.head.appendChild(style);
        }
        // Gán sự kiện click cho các ngày có lịch học
        setTimeout(function() {
            document.querySelectorAll('#calendarYearContainer [data-date]').forEach(function(el) {
                el.onclick = function(e) {
                    let date = el.getAttribute('data-date');
                    showCalendarDayModal(date);
                };
            });
        }, 10);
    }

    // Render calendar on load and when year changes
    function setupCalendarYearSync() {
        const yearSelect = document.getElementById('yearSelect');
        function getSelectedYear() {
            if (yearSelect && yearSelect.value) return parseInt(yearSelect.value);
            return new Date().getFullYear();
        }
        // Lấy lại danh sách ngày có lịch học từ window._calendarHasScheduleDates
        renderCalendarYear(getSelectedYear());
        if (yearSelect) {
            yearSelect.addEventListener('change', function() {
                renderCalendarYear(getSelectedYear());
            });
        }
    }
    const tkbCardListDiv = document.getElementById('tkbCardList');
    const tietModal = document.getElementById('tietModal');
    const openTietModalBtn = document.getElementById('openTietModal');
    const closeTietModalBtn = document.getElementById('closeTietModal');

    // Modal functionality
    if (openTietModalBtn) {
        openTietModalBtn.onclick = function() {
            tietModal.classList.add('show');
        };
    }
    if (closeTietModalBtn) {
        closeTietModalBtn.onclick = function() {
            tietModal.classList.remove('show');
        };
    }
    window.onclick = function(event) {
        if (event.target == tietModal) {
            tietModal.classList.remove('show');
        }
    };

    // --- Ghi nhớ TKB bằng localStorage ---
    function saveTKBToCache(data) {
        localStorage.setItem('tkb_cache', JSON.stringify({data, time: Date.now()}));
    }
    function loadTKBFromCache() {
        let cache = localStorage.getItem('tkb_cache');
        if (!cache) return null;
        try {
            let obj = JSON.parse(cache);
            if (Date.now() - obj.time > 24*60*60*1000) return null;
            return obj.data;
        } catch { return null; }
    }
    function clearTKBCache() {
        localStorage.removeItem('tkb_cache');
    }

    // Chuyển các định dạng ngày về yyyy-mm-dd
    function parseToYMD(dateStr) {
        if (!dateStr) return '';
        dateStr = dateStr.trim().split(' ')[0];
        if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
        let d, m, y;
        if (/^\d{2}[-\/]\d{2}[-\/]\d{4}$/.test(dateStr)) {
            [d, m, y] = dateStr.split(/[-\/]/);
            return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
        }
        if (/^\d{2}[-\/]\d{2}[-\/]\d{2}$/.test(dateStr)) {
            [d, m, y] = dateStr.split(/[-\/]/);
            y = (+y < 50 ? '20' : '19') + y;
            return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
        }
        return dateStr;
    }

    // Định dạng ngày yyyy-mm-dd về dd/mm/yyyy
    function formatDateVN(dateStr) {
        if (!dateStr) return '';
        const [y, m, d] = dateStr.split('-');
        return `${d}/${m}/${y}`;
    }

    // Sinh danh sách năm cho select
    function renderYearSelect(timetableData) {
        const yearSelect = document.getElementById('yearSelect');
        let years = new Set();
        timetableData.forEach(e => {
            let d = parseToYMD(e.from_date);
            if (!d) return;
            let y = d.split('-')[0];
            years.add(y);
        });
        years = Array.from(years).sort();
        yearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
    }

    // Hiển thị danh sách môn học hôm nay
    function renderTodaySubjects(timetableData) {
        const todayBox = document.getElementById('todaySubjectsBox');
        const todayList = document.getElementById('todaySubjectsList');
        const todayEmpty = document.getElementById('todaySubjectsEmpty');
        if (!timetableData || !timetableData.length) {
            todayBox.style.display = 'none';
            return;
        }
        let todayStr = new Date().toISOString().split('T')[0];
        // Lấy các môn học hôm nay (theo ngày from_date)
        let todaySubjects = timetableData.filter(e => parseToYMD(e.from_date) === todayStr);
        if (todaySubjects.length === 0) {
            todayBox.style.display = '';
            todayList.innerHTML = '';
            todayEmpty.style.display = '';
        } else {
            todayBox.style.display = '';
            todayEmpty.style.display = 'none';
            // Hiển thị đủ lớp, gv, buổi cho từng môn học hôm nay
            todayList.innerHTML = todaySubjects.map(e => {
                let subject = e.lopHocPhan || '';
                let teacher = e.giangVien || '';
                let session = e.buoiHoc || '';
                let room = e.phong || '';
                let tiet = e.tiet || '';
                // Tách mã lớp trong ngoặc nếu có
                let classCode = '';
                let match = subject.match(/\(([^)]+)\)$/);
                if (match) {
                    classCode = match[1];
                }
                let showClass = classCode ? ` (${classCode})` : '';
                let tietDisplay = tiet ? `&nbsp;|&nbsp; Tiết: ${tiet}` : '';
                let roomDisplay = room ? `&nbsp;|&nbsp; Lớp: ${room}` : '';
                return `<li><strong>${subject.replace(/\s*\([^)]*\)$/, '')}${showClass}</strong><br><span style=\"color:#555; font-size:0.97em;\">GV: ${teacher} ${tietDisplay} &nbsp;|&nbsp; Buổi: ${session}${roomDisplay}</span></li>`;
            }).join('');
        }
    }

    // Hiển thị thời khóa biểu dạng card, có đủ ngày/tháng/năm
    function renderTimetableCards(timetableData) {
        if (!timetableData || !timetableData.length) {
            tkbCardListDiv.innerHTML = '<div class="empty-data-message">Bạn chưa có thời khóa biểu.</div>';
            return;
        }
        timetableData.sort((a, b) => {
            let da = parseToYMD(a.from_date), db = parseToYMD(b.from_date);
            if (da !== db) return da.localeCompare(db);
            return (parseInt(a.tiet) || 0) - (parseInt(b.tiet) || 0);
        });
        let todayStr = new Date().toISOString().split('T')[0];
        let html = '';
        timetableData.forEach(e => {
            let cardClass = parseToYMD(e.from_date) === todayStr ? 'tkb-card today' : 'tkb-card';
            let d = parseToYMD(e.from_date);
            let [y, m, day] = d.split('-');
            html += `<div class="${cardClass}">\n                <div class="icon"><i class="bi bi-calendar-check"></i></div>\n                <div class="tkb-title">${e.lopHocPhan || ''}</div>\n                <div class="tkb-meta"><i class="bi bi-calendar-day"></i> <strong>Thứ:</strong> ${e.thoiGian || ''}</div>\n                <div class="tkb-meta"><i class="bi bi-clock"></i> <strong>Tiết:</strong> ${e.tiet || ''} &nbsp; <strong>Buổi:</strong> ${e.buoiHoc || ''}</div>\n                <div class="tkb-meta"><span class="tkb-room"><i class="bi bi-geo-alt-fill"></i> ${e.phong || ''}</span> <span><i class="bi bi-person-fill"></i> <strong>GV:</strong> ${e.giangVien || ''}</span></div>\n                ${e.meetLink ? `<div class="tkb-meta"><i class="bi bi-link-45deg"></i> <a class="tkb-link" href="${e.meetLink}" target="_blank">Link Meet</a></div>` : ''}\n                <div class="tkb-date"><i class="bi bi-calendar"></i> Ngày: ${day}/${m}/${y}</div>\n            </div>`;
        });
        tkbCardListDiv.innerHTML = html;
    }

    // Lấy dữ liệu và hiển thị, lọc theo năm/tháng
    async function fetchTimetable(forceRefresh=false) {
        tkbCardListDiv.innerHTML = '<div class="loading-text">Đang tải...</div>';
        if (!forceRefresh) {
            let cached = loadTKBFromCache();
            if (cached) {
                // Hiển thị loading một chút rồi mới render (tránh nháy trắng)
                setTimeout(() => { renderAllViews(cached); }, 200);
                return;
            }
        }
        try {
            const response = await fetch('/api/timetable');
            const data = await response.json();
            if (data.error) {
                tkbCardListDiv.innerHTML = `<div class="empty-data-message">${data.message || 'Lỗi tải thời khóa biểu'}</div>`;
                return;
            }
            if (!data.timetable || data.timetable.length === 0) {
                tkbCardListDiv.innerHTML = `<div class="empty-data-message">${data.message || 'Bạn chưa có thời khóa biểu.'}</div>`;
                return;
            }
            saveTKBToCache(data.timetable);
            renderAllViews(data.timetable);
        } catch (error) {
            console.error('Failed to fetch timetable:', error);
            tkbCardListDiv.innerHTML = '<div class="empty-data-message">Không thể tải thời khóa biểu. Vui lòng thử lại sau.</div>';
        }
    }

    // Hiển thị và lọc theo năm/tháng, đồng thời hiển thị môn học hôm nay
    function renderAllViews(timetable) {
    // renderYearSelect(timetable); // Đã xóa filter-controls
        renderTodaySubjects(timetable);
        // Tạo danh sách ngày có lịch học dạng yyyy-mm-dd
        let hasScheduleDates = [];
        timetable.forEach(e => {
            let d = parseToYMD(e.from_date);
            if (d) hasScheduleDates.push(d);
        });
        // Gán vào window để calendar dùng
        window._calendarHasScheduleDates = hasScheduleDates;
        // Tạo ánh xạ ngày -> danh sách môn học
        let scheduleByDate = {};
        timetable.forEach(e => {
            let d = parseToYMD(e.from_date);
            if (d) {
                if (!scheduleByDate[d]) scheduleByDate[d] = [];
                scheduleByDate[d].push(e);
            }
        });
        window._calendarScheduleByDate = scheduleByDate;
    renderTimetableCards(timetable);
    setupCalendarYearSync();
    }

    // Nút làm mới
    if (refreshBtn) {
        refreshBtn.onclick = function() {
            clearTKBCache();
            fetchTimetable(true);
        };
    }

    // Khi vào trang, ưu tiên cache
    fetchTimetable();
// Hiển thị popup môn học theo ngày
function showCalendarDayModal(dateStr) {
    const modal = document.getElementById('calendarDayModal');
    const modalDate = document.getElementById('calendarDayModalDate');
    const modalBody = document.getElementById('calendarDayModalBody');
    if (!modal || !modalDate || !modalBody) return;
    modalDate.innerHTML = `<i class="bi bi-calendar-event" style="color:#3498db;margin-right:6px;"></i> ${formatDateVN(dateStr)}`;
    let data = (window._calendarScheduleByDate && window._calendarScheduleByDate[dateStr]) || [];
    if (!data.length) {
        modalBody.innerHTML = `<div style="padding:28px 10px;text-align:center;color:#27ae60;font-size:1.15rem;">
            <i class="bi bi-emoji-smile" style="font-size:2.2rem;display:block;margin-bottom:8px;"></i>
            Không có môn học nào trong ngày này.
        </div>`;
    } else {
        modalBody.innerHTML = '<div style="display:flex;flex-direction:column;gap:14px;">' + data.map(e => {
            let subject = e.lopHocPhan || '';
            let teacher = e.giangVien || '';
            let session = e.buoiHoc || '';
            let room = e.phong || '';
            let tiet = e.tiet || '';
            let tietDisplay = tiet ? `<span style=\"color:#2980b9;font-weight:500;\"><i class='bi bi-clock'></i> Tiết: ${tiet}</span>` : '';
            let roomDisplay = room ? `<span style=\"color:#fff;background:#3498db;border-radius:5px;padding:2px 10px;margin-left:8px;font-weight:600;\"><i class='bi bi-geo-alt-fill'></i> ${room}</span>` : '';
            return `<div style=\"border:1.5px solid #eaf6fb;border-radius:10px;padding:14px 16px;background:#fafdff;box-shadow:0 2px 8px #0001;display:flex;align-items:flex-start;gap:12px;\">
                <div style=\"font-size:2.1rem;color:#3498db;flex-shrink:0;\"><i class='bi bi-journal-bookmark-fill'></i></div>
                <div style=\"flex:1;\">
                    <div style=\"font-size:1.13rem;font-weight:700;color:#2c3e50;\">${subject}</div>
                    <div style=\"color:#555;font-size:0.98em;margin:3px 0 0 0;\"><i class='bi bi-person-fill'></i> GV: <b>${teacher}</b> ${tietDisplay} <span style=\"margin-left:8px;\"><i class='bi bi-sun'></i> Buổi: <b>${session}</b></span> ${roomDisplay}</div>
                </div>
            </div>`;
        }).join('') + '</div>';
    }
    modal.classList.add('show');
}
// Đóng popup môn học theo ngày
setTimeout(function() {
    const closeBtn = document.getElementById('closeCalendarDayModal');
    const modal = document.getElementById('calendarDayModal');
    if (closeBtn && modal) {
        closeBtn.onclick = function() { modal.classList.remove('show'); };
    }
    if (modal) {
        modal.addEventListener('click', function(event) {
            if (event.target === modal) {
                modal.classList.remove('show');
            }
        });
    }
}, 0);
});
</script>
</body>
</html>