<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thời khóa biểu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(120deg, #f8fafc 60%, #e0e7ff 100%); }
        .main-card { max-width: 1100px; margin: 40px auto; padding: 36px 32px 28px 32px; border-radius: 18px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); background: #fff; }
        .tkb-card-list { display: flex; flex-direction: column; gap: 18px; margin-top: 18px; }
        .tkb-card {
            background: linear-gradient(90deg, #e3fdfd 0%, #cbf1f5 100%);
            border-radius: 16px;
            box-shadow: 0 2px 12px #00bcd422;
            padding: 18px 22px 14px 22px;
            display: flex;
            align-items: flex-start;
            gap: 18px;
            position: relative;
            border: none;
            transition: box-shadow 0.2s, border 0.2s;
        }
        .tkb-card.today {
            border: 2.5px solid #00bcd4;
            box-shadow: 0 4px 18px #00bcd455;
        }
        .tkb-card .icon {
            flex-shrink: 0;
            margin-top: 2px;
        }
        .tkb-card .tkb-info {
            flex: 1;
        }
        .tkb-card .tkb-title {
            font-size: 1.13rem;
            font-weight: 700;
            color: #00838f;
            margin-bottom: 2px;
        }
        .tkb-card .tkb-meta {
            font-size: 0.98rem;
            color: #006064;
            margin-bottom: 2px;
        }
        .tkb-card .tkb-meta strong { color: #00838f; }
        .tkb-card .tkb-room {
            font-size: 0.97rem;
            color: #fff;
            background: #00bcd4;
            border-radius: 7px;
            padding: 3px 12px;
            display: inline-block;
            margin-right: 8px;
        }
        .tkb-card .tkb-link {
            font-size: 0.97rem;
            color: #00838f;
            text-decoration: underline;
        }
        .tkb-card .tkb-date {
            font-size: 0.97rem;
            color: #00838f;
            font-weight: 500;
            margin-top: 2px;
        }
    </style>
</head>
<body>
<div class="main-card">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Thời khóa biểu</h2>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#tietModal">Thời gian biểu</button>
            <button id="refreshTKB" class="btn btn-outline-primary" type="button">Làm mới TKB</button>
            <a href="/" class="btn btn-outline-primary">Trang chủ</a>
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-md-3">
            <select id="yearSelect" class="form-select"></select>
        </div>
        <div class="col-md-3">
            <select id="monthSelect" class="form-select">
                <option value="">Tất cả các tháng</option>
                <option value="01">Tháng 1</option>
                <option value="02">Tháng 2</option>
                <option value="03">Tháng 3</option>
                <option value="04">Tháng 4</option>
                <option value="05">Tháng 5</option>
                <option value="06">Tháng 6</option>
                <option value="07">Tháng 7</option>
                <option value="08">Tháng 8</option>
                <option value="09">Tháng 9</option>
                <option value="10">Tháng 10</option>
                <option value="11">Tháng 11</option>
                <option value="12">Tháng 12</option>
            </select>
        </div>
    </div>
    <div class="tkb-card-list" id="tkbCardList">Đang tải...</div>
</div>

<!-- Modal Tiết học -->
<div class="modal fade" id="tietModal" tabindex="-1" aria-labelledby="tietModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="tietModalLabel">Thời gian biểu</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <table class="table table-bordered table-striped align-middle">
            <thead>
                <tr>
                    <th>Tiết</th>
                    <th>Bắt đầu</th>
                    <th>Kết thúc</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>1</td><td>6:45</td><td>7:35</td></tr>
                <tr><td>2</td><td>7:40</td><td>8:30</td></tr>
                <tr><td>3</td><td>8:40</td><td>9:30</td></tr>
                <tr><td>4</td><td>9:40</td><td>10:30</td></tr>
                <tr><td>5</td><td>10:35</td><td>11:25</td></tr>
                <tr><td>6</td><td>13:00</td><td>13:50</td></tr>
                <tr><td>7</td><td>13:55</td><td>14:45</td></tr>
                <tr><td>8</td><td>14:55</td><td>15:45</td></tr>
                <tr><td>9</td><td>15:55</td><td>16:45</td></tr>
                <tr><td>10</td><td>16:50</td><td>17:40</td></tr>
                <tr><td>11</td><td>18:15</td><td>19:05</td></tr>
                <tr><td>12</td><td>19:10</td><td>20:00</td></tr>
                <tr><td>13</td><td>20:05</td><td>20:55</td></tr>
                <tr><td>14</td><td>20:20</td><td>21:10</td></tr>
                <tr><td>15</td><td>21:20</td><td>22:10</td></tr>
            </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tkbCardListDiv = document.getElementById('tkbCardList');
    const refreshBtn = document.getElementById('refreshTKB');

    // --- Ghi nhớ TKB bằng localStorage ---
    function saveTKBToCache(data) {
        localStorage.setItem('tkb_cache', JSON.stringify({data, time: Date.now()}));
    }
    function loadTKBFromCache() {
        let cache = localStorage.getItem('tkb_cache');
        if (!cache) return null;
        try {
            let obj = JSON.parse(cache);
            if (Date.now() - obj.time > 24*60*60*1000) return null;
            return obj.data;
        } catch { return null; }
    }
    function clearTKBCache() {
        localStorage.removeItem('tkb_cache');
    }

    // Chuyển các định dạng ngày về yyyy-mm-dd
    function parseToYMD(dateStr) {
        if (!dateStr) return '';
        dateStr = dateStr.trim().split(' ')[0];
        if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
        let d, m, y;
        if (/^\d{2}[-\/]\d{2}[-\/]\d{4}$/.test(dateStr)) {
            [d, m, y] = dateStr.split(/[-\/]/);
            return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
        }
        if (/^\d{2}[-\/]\d{2}[-\/]\d{2}$/.test(dateStr)) {
            [d, m, y] = dateStr.split(/[-\/]/);
            y = (+y < 50 ? '20' : '19') + y;
            return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
        }
        return dateStr;
    }

    // Định dạng ngày yyyy-mm-dd về dd/mm/yyyy
    function formatDateVN(dateStr) {
        if (!dateStr) return '';
        const [y, m, d] = dateStr.split('-');
        return `${d}/${m}/${y}`;
    }

    // Sinh danh sách năm cho select
    function renderYearSelect(timetableData) {
        const yearSelect = document.getElementById('yearSelect');
        let years = new Set();
        timetableData.forEach(e => {
            let d = parseToYMD(e.from_date);
            if (!d) return;
            let y = d.split('-')[0];
            years.add(y);
        });
        years = Array.from(years).sort();
        yearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
    }

    // Hiển thị thời khóa biểu dạng card, có đủ ngày/tháng/năm
    function renderTimetableCards(timetableData) {
        if (!timetableData || !timetableData.length) {
            tkbCardListDiv.innerHTML = '<div class="text-center text-secondary">Bạn chưa có thời khóa biểu.</div>';
            return;
        }
        timetableData.sort((a, b) => {
            let da = parseToYMD(a.from_date), db = parseToYMD(b.from_date);
            if (da !== db) return da.localeCompare(db);
            return (parseInt(a.tiet) || 0) - (parseInt(b.tiet) || 0);
        });
        let todayStr = new Date().toISOString().split('T')[0];
        let html = '';
        timetableData.forEach(e => {
            let cardClass = parseToYMD(e.from_date) === todayStr ? 'tkb-card today' : 'tkb-card';
            let d = parseToYMD(e.from_date);
            let [y, m, day] = d.split('-');
            html += `<div class="${cardClass}">\n                <div class="icon">\n                    <svg xmlns='http://www.w3.org/2000/svg' width='28' height='28' fill='none' viewBox='0 0 24 24'><rect x='3' y='4' width='18' height='16' rx='4' fill='#00bcd4'/><rect x='7' y='8' width='10' height='2' rx='1' fill='#4dd0e1'/><rect x='7' y='12' width='6' height='2' rx='1' fill='#4dd0e1'/></svg>\n                </div>\n                <div class="tkb-info">\n                    <div class="tkb-title">${e.lopHocPhan || ''}</div>\n                    <div class="tkb-meta"><strong>Thứ:</strong> ${e.thoiGian || ''} &nbsp; <strong>Tiết:</strong> ${e.tiet || ''} &nbsp; <strong>Buổi:</strong> ${e.buoiHoc || ''}</div>\n                    <div class="tkb-meta"><span class="tkb-room">${e.phong || ''}</span> <span><strong>GV:</strong> ${e.giangVien || ''}</span></div>\n                    ${e.meetLink ? `<div class="tkb-meta"><a class="tkb-link" href="${e.meetLink}" target="_blank">Link Meet</a></div>` : ''}\n                </div>\n                <div class="tkb-date">Ngày: ${day}/${m}/${y}</div>\n            </div>`;
        });
        tkbCardListDiv.innerHTML = html;
    }

    // Lấy dữ liệu và hiển thị, lọc theo năm/tháng
    async function fetchTimetable(forceRefresh=false) {
        if (!forceRefresh) {
            let cached = loadTKBFromCache();
            if (cached) {
                renderAllViews(cached);
                return;
            }
        }
        tkbCardListDiv.innerHTML = 'Đang tải...';
        try {
            const response = await fetch('/api/timetable');
            const data = await response.json();
            if (data.error) {
                tkbCardListDiv.textContent = data.message || 'Lỗi tải thời khóa biểu';
                return;
            }
            if (!data.timetable || data.timetable.length === 0) {
                tkbCardListDiv.textContent = data.message || 'Bạn chưa có thời khóa biểu.';
                return;
            }
            saveTKBToCache(data.timetable);
            renderAllViews(data.timetable);
        } catch (error) {
            console.error('Failed to fetch timetable:', error);
            tkbCardListDiv.textContent = 'Không thể tải thời khóa biểu. Vui lòng thử lại sau.';
        }
    }

    // Hiển thị và lọc theo năm/tháng
    function renderAllViews(timetable) {
        renderYearSelect(timetable);
        let yearSelect = document.getElementById('yearSelect');
        let monthSelect = document.getElementById('monthSelect');
        function filterAndRender() {
            let y = yearSelect.value;
            let m = monthSelect.value;
            let filtered = timetable.filter(e => {
                let d = parseToYMD(e.from_date);
                if (!d.startsWith(y)) return false;
                if (m && d.split('-')[1] !== m) return false;
                return true;
            });
            renderTimetableCards(filtered);
        }
        filterAndRender();
        yearSelect.onchange = filterAndRender;
        monthSelect.onchange = filterAndRender;
    }

    // Nút làm mới
    if (refreshBtn) {
        refreshBtn.onclick = function() {
            clearTKBCache();
            fetchTimetable(true);
        };
    }

    // Khi vào trang, ưu tiên cache
    fetchTimetable();
});
</script>
</body>
</html>