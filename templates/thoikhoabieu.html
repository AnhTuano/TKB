<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thời khóa biểu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body { background: #f8fafc; }
        .main-card { max-width: 1100px; margin: 32px auto; padding: 18px 2px 10px 2px; border-radius: 16px; box-shadow: 0 2px 12px #0001; background: #fff; }
        .tkb-card-list { display: flex; flex-direction: column; gap: 12px; margin-top: 8px; }
        .tkb-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px #00bcd422;
            padding: 12px 14px 10px 14px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            border: 1px solid #e0e7ff;
        }
        .tkb-card.today {
            border: 2px solid #00bcd4;
            box-shadow: 0 4px 18px #00bcd455;
        }
        .tkb-card .tkb-title {
            font-size: 1.08rem;
            font-weight: 700;
            color: #00838f;
            margin-bottom: 2px;
        }
        .tkb-card .tkb-meta {
            font-size: 0.97rem;
            color: #006064;
            margin-bottom: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        .tkb-card .tkb-label {
            font-weight: 600;
            color: #2563eb;
            min-width: 60px;
            display: inline-block;
        }
        .tkb-card .tkb-room {
            font-size: 0.97rem;
            color: #fff;
            background: #00bcd4;
            border-radius: 7px;
            padding: 2px 10px;
            display: inline-block;
            margin-right: 6px;
        }
        .tkb-card .tkb-date {
            font-size: 0.97rem;
            color: #00838f;
            font-weight: 500;
            margin-top: 2px;
            text-align: right;
        }
        @media (max-width: 600px) {
            .main-card { max-width: 100vw; margin: 0; padding: 2px 0 4px 0; border-radius: 0; }
            .tkb-card-list { gap: 7px; }
            .tkb-card {
                padding: 8px 6px 7px 8px;
                border-radius: 10px;
                font-size: 1rem;
            }
            .tkb-card .tkb-title { font-size: 1.04rem; margin-bottom: 1px; }
            .tkb-card .tkb-meta { font-size: 0.96rem; gap: 8px; }
            .tkb-card .tkb-label { min-width: 54px; }
            .tkb-card .tkb-date { font-size: 0.95rem; margin-top: 1px; }
            .tkb-btn-group {
                flex-direction: row !important;
                align-items: center !important;
                justify-content: flex-end !important;
                gap: 7px !important;
            }
            .tkb-btn-group .btn {
                width: 44px;
                min-width: 44px;
                max-width: 44px;
                height: 44px;
                padding: 0;
                font-size: 1.2rem;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .tkb-btn-group .btn span { display: none; }
        }
    </style>
</head>
<body>
<div class="main-card">
    <div class="d-flex justify-content-between align-items-center mb-4 tkb-actions flex-wrap">
        <h2 class="mb-0 flex-grow-1" style="min-width:120px;">Thời khóa biểu</h2>
        <div class="d-flex tkb-btn-group gap-2">
            <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#tietModal" title="Thời gian biểu">
                <i class="fa-solid fa-clock"></i>
                <span>Thời gian biểu</span>
            </button>
            <button id="refreshTKB" class="btn btn-outline-primary" type="button" title="Làm mới TKB">
                <i class="fa-solid fa-rotate-right"></i>
                <span>Làm mới TKB</span>
            </button>
            <a href="/" class="btn btn-outline-primary" title="Trang chủ">
                <i class="fa-solid fa-house"></i>
                <span>Trang chủ</span>
            </a>
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-md-3">
            <select id="yearSelect" class="form-select"></select>
        </div>
        <div class="col-md-3">
            <select id="monthSelect" class="form-select">
                <option value="">Tất cả các tháng</option>
                <option value="01">Tháng 1</option>
                <option value="02">Tháng 2</option>
                <option value="03">Tháng 3</option>
                <option value="04">Tháng 4</option>
                <option value="05">Tháng 5</option>
                <option value="06">Tháng 6</option>
                <option value="07">Tháng 7</option>
                <option value="08">Tháng 8</option>
                <option value="09">Tháng 9</option>
                <option value="10">Tháng 10</option>
                <option value="11">Tháng 11</option>
                <option value="12">Tháng 12</option>
            </select>
        </div>
    </div>
    <div class="tkb-card-list" id="tkbCardList">Đang tải...</div>
</div>

<!-- Modal Tiết học -->
<div class="modal fade" id="tietModal" tabindex="-1" aria-labelledby="tietModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="tietModalLabel">Thời gian biểu</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <table class="table table-bordered table-striped align-middle">
            <thead>
                <tr>
                    <th>Tiết</th>
                    <th>Bắt đầu</th>
                    <th>Kết thúc</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>1</td><td>6:45</td><td>7:35</td></tr>
                <tr><td>2</td><td>7:40</td><td>8:30</td></tr>
                <tr><td>3</td><td>8:40</td><td>9:30</td></tr>
                <tr><td>4</td><td>9:40</td><td>10:30</td></tr>
                <tr><td>5</td><td>10:35</td><td>11:25</td></tr>
                <tr><td>6</td><td>13:00</td><td>13:50</td></tr>
                <tr><td>7</td><td>13:55</td><td>14:45</td></tr>
                <tr><td>8</td><td>14:55</td><td>15:45</td></tr>
                <tr><td>9</td><td>15:55</td><td>16:45</td></tr>
                <tr><td>10</td><td>16:50</td><td>17:40</td></tr>
                <tr><td>11</td><td>18:15</td><td>19:05</td></tr>
                <tr><td>12</td><td>19:10</td><td>20:00</td></tr>
                <tr><td>13</td><td>20:05</td><td>20:55</td></tr>
                <tr><td>14</td><td>20:20</td><td>21:10</td></tr>
                <tr><td>15</td><td>21:20</td><td>22:10</td></tr>
            </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tkbCardListDiv = document.getElementById('tkbCardList');
    const refreshBtn = document.getElementById('refreshTKB');

    // --- Ghi nhớ TKB bằng localStorage ---
    function saveTKBToCache(data) {
        localStorage.setItem('tkb_cache', JSON.stringify({data, time: Date.now()}));
    }
    function loadTKBFromCache() {
        let cache = localStorage.getItem('tkb_cache');
        if (!cache) return null;
        try {
            let obj = JSON.parse(cache);
            if (Date.now() - obj.time > 24*60*60*1000) return null;
            return obj.data;
        } catch { return null; }
    }
    function clearTKBCache() {
        localStorage.removeItem('tkb_cache');
    }

    // Chuyển các định dạng ngày về yyyy-mm-dd
    function parseToYMD(dateStr) {
        if (!dateStr) return '';
        dateStr = dateStr.trim().split(' ')[0];
        if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
        let d, m, y;
        if (/^\d{2}[-\/]\d{2}[-\/]\d{4}$/.test(dateStr)) {
            [d, m, y] = dateStr.split(/[-\/]/);
            return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
        }
        if (/^\d{2}[-\/]\d{2}[-\/]\d{2}$/.test(dateStr)) {
            [d, m, y] = dateStr.split(/[-\/]/);
            y = (+y < 50 ? '20' : '19') + y;
            return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
        }
        return dateStr;
    }

    // Định dạng ngày yyyy-mm-dd về dd/mm/yyyy
    function formatDateVN(dateStr) {
        if (!dateStr) return '';
        const [y, m, d] = dateStr.split('-');
        return `${d}/${m}/${y}`;
    }

    // Sinh danh sách năm cho select
    function renderYearSelect(timetableData) {
        const yearSelect = document.getElementById('yearSelect');
        let years = new Set();
        timetableData.forEach(e => {
            let d = parseToYMD(e.from_date);
            if (!d) return;
            let y = d.split('-')[0];
            years.add(y);
        });
        years = Array.from(years).sort();
        yearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
    }

    // Hiển thị thời khóa biểu dạng card, có đủ ngày/tháng/năm
    function renderTimetableCards(timetableData) {
        if (!timetableData || !timetableData.length) {
            tkbCardListDiv.innerHTML = '<div class="text-center text-secondary">Bạn chưa có thời khóa biểu.</div>';
            return;
        }
        timetableData.sort((a, b) => {
            let da = parseToYMD(a.from_date), db = parseToYMD(b.from_date);
            if (da !== db) return da.localeCompare(db);
            return (parseInt(a.tiet) || 0) - (parseInt(b.tiet) || 0);
        });
        let todayStr = new Date().toISOString().split('T')[0];
        let html = '';
        timetableData.forEach(e => {
            let cardClass = parseToYMD(e.from_date) === todayStr ? 'tkb-card today' : 'tkb-card';
            let d = parseToYMD(e.from_date);
            let [y, m, day] = d.split('-');
            html += `<div class="${cardClass}">
                <div class="tkb-title">${e.lopHocPhan || ''}</div>
                <div class="tkb-meta"><span class="tkb-label">Thứ:</span> ${e.thoiGian || ''} <span class="tkb-label">Tiết:</span> ${e.tiet || ''}</div>
                <div class="tkb-meta"><span class="tkb-label">Phòng:</span> <span class="tkb-room">${e.phong || ''}</span> <span class="tkb-label">GV:</span> ${e.giangVien || ''}</div>
                <div class="tkb-meta">${e.meetLink ? `<span class='tkb-label'>Link:</span> <a class='tkb-link' href='${e.meetLink}' target='_blank'>Tham gia</a>` : ''}</div>
                <div class="tkb-date">${day}/${m}/${y}</div>
            </div>`;
        });
        tkbCardListDiv.innerHTML = html;
    }

    // Lấy dữ liệu và hiển thị, lọc theo năm/tháng
    async function fetchTimetable(forceRefresh=false) {
        if (!forceRefresh) {
            let cached = loadTKBFromCache();
            if (cached) {
                renderAllViews(cached);
                return;
            }
        }
        tkbCardListDiv.innerHTML = 'Đang tải...';
        try {
            const response = await fetch('/api/timetable');
            const data = await response.json();
            if (data.error) {
                tkbCardListDiv.textContent = data.message || 'Lỗi tải thời khóa biểu';
                return;
            }
            if (!data.timetable || data.timetable.length === 0) {
                tkbCardListDiv.textContent = data.message || 'Bạn chưa có thời khóa biểu.';
                return;
            }
            saveTKBToCache(data.timetable);
            renderAllViews(data.timetable);
        } catch (error) {
            console.error('Failed to fetch timetable:', error);
            tkbCardListDiv.textContent = 'Không thể tải thời khóa biểu. Vui lòng thử lại sau.';
        }
    }

    // Hiển thị và lọc theo năm/tháng
    function renderAllViews(timetable) {
        renderYearSelect(timetable);
        let yearSelect = document.getElementById('yearSelect');
        let monthSelect = document.getElementById('monthSelect');
        function filterAndRender() {
            let y = yearSelect.value;
            let m = monthSelect.value;
            let filtered = timetable.filter(e => {
                let d = parseToYMD(e.from_date);
                if (!d.startsWith(y)) return false;
                if (m && d.split('-')[1] !== m) return false;
                return true;
            });
            renderTimetableCards(filtered);
        }
        filterAndRender();
        yearSelect.onchange = filterAndRender;
        monthSelect.onchange = filterAndRender;
    }

    // Nút làm mới
    if (refreshBtn) {
        refreshBtn.onclick = function() {
            clearTKBCache();
            fetchTimetable(true);
        };
    }

    // Khi vào trang, ưu tiên cache
    fetchTimetable();
});
</script>
</body>
</html>